<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WAIMMO ‚Äî Pipeline Acqu√©reurs</title>
    <meta property="og:title" content="WAIMMO ‚Äî CRM Immobilier">
    <meta property="og:image" content="/img/F.png">
    <meta property="og:type" content="website">
    <link href="https://fonts.googleapis.com/css2?family=Barlow+Semi+Condensed:wght@400;500;600;700;800&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase-config.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/audio-recorder.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --new-color: #00D2FF;
            --active-color: #7C4DFF;
            --bought-color: #00E676;
            --lost-color: #FF5252;
            --text-dark: #2C3E50;
            --text-light: #7F8C8D;
            --border-color: #E1E8ED;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            --shadow-hover: 0 8px 24px rgba(0, 0, 0, 0.12);
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #f0f2f5 0%, #e8eaf6 100%);
            min-height: 100vh;
            padding: 20px;
            color: var(--text-dark);
            overflow-x: hidden;
        }

        /* ===== HEADER & NAVIGATION ===== */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding: 16px 30px;
            background: url('img/header_bg.png') center / cover no-repeat;
            border-radius: 16px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
        }

        .logo {
            display: flex;
            align-items: center;
            text-decoration: none;
        }

        .logo img {
            width: 160px;
            height: auto;
        }

        .nav-tabs {
            display: flex;
            gap: 8px;
        }

        .nav-tab {
            color: var(--text-dark);
            text-decoration: none;
            padding: 10px 20px;
            border-radius: 10px;
            font-family: 'Inter', sans-serif;
            font-weight: 600;
            font-size: 15px;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.7);
        }

        .nav-tab:hover {
            color: #667eea;
            background: rgba(255, 255, 255, 0.9);
        }

        .nav-tab.active {
            color: #667eea;
            background: rgba(255, 255, 255, 0.95);
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 2px solid #e8eaf6;
            object-fit: cover;
        }

        .user-name {
            color: var(--text-dark);
            font-weight: 600;
            font-size: 14px;
            white-space: nowrap;
        }

        .logout-btn {
            background: rgba(0, 0, 0, 0.06);
            border: none;
            color: var(--text-light);
            width: 28px;
            height: 28px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }

        .logout-btn:hover {
            background: rgba(0, 0, 0, 0.12);
        }

        .alert-counter {
            display: flex;
            align-items: center;
            gap: 10px;
            background: #f8f9fa;
            padding: 12px 20px;
            border-radius: 12px;
            box-shadow: none;
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .alert-counter:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
        }

        .alert-counter.has-alerts {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
        }

        .alert-counter.has-alerts .alert-text { color: white; }

        .alert-counter.has-alerts .alert-icon { animation: ring 2s infinite; }

        @keyframes ring {
            0%, 100% { transform: rotate(0deg); }
            10%, 30% { transform: rotate(-10deg); }
            20%, 40% { transform: rotate(10deg); }
        }

        .alert-icon { font-size: 24px; }

        .alert-text {
            font-family: 'Inter', sans-serif;
            font-weight: 600;
            font-size: 14px;
            color: #667eea;
            transition: color 0.3s ease;
        }

        .alert-number {
            font-size: 20px;
            font-weight: 800;
            font-family: 'Barlow Semi Condensed', sans-serif;
        }

        .add-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            font-weight: 600;
            font-size: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
            font-family: 'Inter', sans-serif;
        }

        .add-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(102, 126, 234, 0.4);
        }

        /* ===== EXPORT BUTTON & DROPDOWN ===== */
        .export-wrapper {
            position: relative;
        }

        .export-btn {
            background: transparent;
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.6);
            padding: 10px 20px;
            border-radius: 10px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Inter', sans-serif;
            white-space: nowrap;
        }

        .export-btn:hover {
            background: rgba(255, 255, 255, 0.15);
            border-color: white;
            transform: translateY(-2px);
        }

        .export-dropdown {
            display: none;
            position: absolute;
            top: calc(100% + 8px);
            right: 0;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.18);
            min-width: 260px;
            z-index: 1000;
            overflow: hidden;
        }

        .export-dropdown.active { display: block; }

        .export-dropdown-item {
            display: block;
            width: 100%;
            padding: 12px 18px;
            border: none;
            background: none;
            text-align: left;
            font-family: 'Inter', sans-serif;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-dark);
            cursor: pointer;
            transition: background 0.15s;
        }

        .export-dropdown-item:hover { background: #f0f4ff; }

        .export-dropdown-sub {
            padding-left: 32px;
            font-size: 13px;
            color: var(--text-light);
        }

        .export-dropdown-sub:hover { color: var(--text-dark); }

        /* ===== PIPELINE ===== */
        .pipeline {
            display: grid;
            grid-template-columns: repeat(4, minmax(320px, 1fr));
            gap: 20px;
            overflow-x: auto;
            overflow-y: visible;
            padding-bottom: 20px;
            cursor: grab;
        }
        .pipeline.grabbing { cursor: grabbing; }

        .pipeline::-webkit-scrollbar { height: 12px; }
        .pipeline::-webkit-scrollbar-track { background: rgba(0, 0, 0, 0.05); border-radius: 10px; }
        .pipeline::-webkit-scrollbar-thumb { background: rgba(0, 0, 0, 0.15); border-radius: 10px; }
        .pipeline::-webkit-scrollbar-thumb:hover { background: rgba(0, 0, 0, 0.25); }

        .column {
            background: rgba(255, 255, 255, 0.75);
            border-radius: 16px;
            padding: 20px;
            min-height: 500px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            animation: slideUp 0.5s ease;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .column-header {
            position: relative;
            margin-bottom: 20px;
            overflow: hidden;
            border-radius: 16px;
            height: 160px;
            background-size: cover;
            background-position: top;
        }

        .column-header.header-new { background-image: url('img/nouveaux.png'); }
        .column-header.header-active { background-image: url('img/actifs.png'); }
        .column-header.header-bought { background-image: url('img/achetes.png'); }
        .column-header.header-lost { background-image: url('img/plusenrecherche.png'); }

        .column-label {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 12px 16px;
            font-family: 'Barlow Semi Condensed', sans-serif;
            font-size: 22px;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: white;
            text-shadow: 1px 1px 6px rgba(0, 0, 0, 0.5);
            font-style: italic;
        }

        .column-title {
            font-family: 'Barlow Semi Condensed', sans-serif;
            font-size: 18px;
            font-weight: 700;
            text-transform: uppercase;
            margin-top: 15px;
            margin-bottom: 10px;
            color: var(--text-dark);
        }

        .column-count {
            display: flex;
            align-items: center;
            gap: 6px;
            color: var(--text-light);
            font-size: 14px;
            margin-bottom: 20px;
        }

        .cards-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
            min-height: 200px;
        }

        /* ===== CARTES ACQU√âREURS ===== */
        .lead-card {
            background: white;
            border-radius: 12px;
            padding: 16px;
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
            cursor: grab;
            border: 2px solid transparent;
            animation: cardAppear 0.4s ease;
            position: relative;
        }

        @keyframes cardAppear {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }

        @keyframes highlight {
            0%, 100% { box-shadow: var(--shadow); }
            50% { box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.5), var(--shadow-hover); transform: scale(1.02); }
        }

        .lead-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-hover);
        }

        .lead-card.dragging { opacity: 0.5; cursor: grabbing; }

        /* ===== BADGES ===== */
        .card-badges {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-bottom: 10px;
        }

        .badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .badge-type-appartement { background: #E3F2FD; color: #1565C0; }
        .badge-type-maison { background: #FFF3E0; color: #E65100; }
        .badge-type-terrain { background: #E8F5E9; color: #2E7D32; }
        .badge-type-immeuble { background: #FCE4EC; color: #C2185B; }

        .badge-rooms { background: #F3E5F5; color: #7B1FA2; }
        .badge-sector { background: #E8EAF6; color: #283593; }
        .badge-budget { background: #FFF8E1; color: #F57F17; }

        .badge-seller {
            background: linear-gradient(135deg, #FF9800, #FF5722);
            color: white;
            animation: glowSeller 2s infinite;
        }

        @keyframes glowSeller {
            0%, 100% { box-shadow: 0 0 5px rgba(255, 152, 0, 0.4); }
            50% { box-shadow: 0 0 15px rgba(255, 152, 0, 0.8); }
        }

        .card-tag {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .card-name {
            font-weight: 700;
            font-size: 16px;
            margin-bottom: 6px;
            color: var(--text-dark);
        }

        .card-info {
            font-size: 14px;
            color: var(--text-light);
            line-height: 1.5;
            margin-bottom: 4px;
        }

        .card-notes {
            font-size: 13px;
            color: var(--text-dark);
            background: #f8f9fa;
            padding: 8px;
            border-radius: 6px;
            margin-top: 8px;
            line-height: 1.4;
            font-style: italic;
            max-height: 60px;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .card-links-count {
            font-size: 12px;
            color: var(--text-light);
            margin-top: 6px;
        }

        .card-followup {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 6px;
            margin-top: 8px;
            font-weight: 600;
        }

        .followup-ok { background: #d1f2eb; color: #0c5460; }
        .followup-due { background: #fff3cd; color: #856404; }
        .followup-overdue { background: #f8d7da; color: #721c24; animation: pulse 2s infinite; }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .badge-alert {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #dc3545;
            color: white;
            font-size: 10px;
            font-weight: 700;
            padding: 4px 8px;
            border-radius: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            animation: pulse 2s infinite;
        }

        .card-actions {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            margin-top: 10px;
        }

        .card-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 6px;
            color: var(--text-light);
            transition: color 0.2s ease;
            font-size: 18px;
        }

        .card-btn:hover { color: var(--text-dark); }

        /* ===== MODAL ===== */
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(8px);
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .modal.active {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 20px;
            overflow-y: auto;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 700px;
            width: 100%;
            margin: 20px auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-50px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .modal-title {
            font-family: 'Barlow Semi Condensed', sans-serif;
            font-size: 28px;
            font-weight: 800;
            text-transform: uppercase;
            color: var(--text-dark);
        }

        .close-btn {
            background: #f0f0f0;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #333;
            transition: all 0.2s ease;
            padding: 0;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .close-btn:hover { background: #e0e0e0; color: #111; }

        .form-section {
            margin-bottom: 28px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .form-section:last-child { border-bottom: none; }

        .form-section-title {
            font-family: 'Barlow Semi Condensed', sans-serif;
            font-size: 18px;
            font-weight: 700;
            text-transform: uppercase;
            color: #667eea;
            margin-bottom: 16px;
            letter-spacing: 0.5px;
        }

        .form-group { margin-bottom: 20px; }

        .form-label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-dark);
            font-size: 14px;
        }

        .form-input,
        .form-select,
        .form-textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            font-size: 15px;
            font-family: 'Inter', sans-serif;
            transition: all 0.3s ease;
            background: white;
        }

        .form-input:focus,
        .form-select:focus,
        .form-textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-textarea { resize: vertical; min-height: 80px; }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .form-row-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 16px;
        }

        /* Crit√®res toggles */
        .criteria-toggles {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .criteria-toggle input { display: none; }

        .criteria-toggle span {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            border: 2px solid var(--border-color);
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            font-weight: 500;
        }

        .criteria-toggle input:checked + span {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: transparent;
        }

        .criteria-toggle span:hover {
            border-color: #667eea;
        }

        .referrer-group {
            max-height: 0;
            overflow: hidden;
            opacity: 0;
            transition: max-height 0.3s ease, opacity 0.3s ease, margin 0.3s ease;
            margin-top: 0;
        }
        .referrer-group.active {
            max-height: 300px;
            overflow: visible;
            opacity: 1;
            margin-top: 12px;
        }
        .referrer-via {
            font-size: 12px;
            color: #999;
            font-style: italic;
            margin-top: 2px;
        }

        /* Toggle switch vendeur */
        .seller-toggle-group {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        .toggle-switch {
            position: relative;
            width: 52px;
            height: 28px;
            flex-shrink: 0;
        }

        .toggle-switch input { display: none; }

        .toggle-slider {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: #ccc;
            border-radius: 28px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .toggle-slider::before {
            content: '';
            position: absolute;
            width: 22px;
            height: 22px;
            left: 3px;
            bottom: 3px;
            background: white;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .toggle-switch input:checked + .toggle-slider {
            background: linear-gradient(135deg, #FF9800, #FF5722);
        }

        .toggle-switch input:checked + .toggle-slider::before {
            transform: translateX(24px);
        }

        .seller-fields {
            background: #FFF3E0;
            border-radius: 12px;
            padding: 16px;
            margin-top: 12px;
            border: 2px solid #FFE0B2;
        }

        /* Section liens */
        .links-section { margin-top: 12px; }

        .link-item {
            display: flex;
            align-items: center;
            gap: 10px;
            background: #f8f9fa;
            padding: 10px 14px;
            border-radius: 10px;
            margin-bottom: 8px;
        }

        .link-platform {
            font-size: 18px;
            flex-shrink: 0;
        }

        .link-url {
            flex: 1;
            font-size: 13px;
            color: #667eea;
            text-decoration: none;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .link-status-select {
            padding: 6px 10px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 12px;
            font-family: 'Inter', sans-serif;
            background: white;
        }

        .link-delete-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            color: var(--text-light);
            transition: color 0.2s;
        }

        .link-delete-btn:hover { color: #FF5252; }

        .add-link-row {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }

        .add-link-row input {
            flex: 1;
            padding: 10px 14px;
            border: 2px dashed var(--border-color);
            border-radius: 10px;
            font-size: 14px;
            font-family: 'Inter', sans-serif;
        }

        .add-link-row input:focus {
            outline: none;
            border-color: #667eea;
        }

        .add-link-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 10px 18px;
            border-radius: 10px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .add-link-btn:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4); }

        .submit-btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-weight: 700;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 10px;
            font-family: 'Barlow Semi Condensed', sans-serif;
        }

        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(102, 126, 234, 0.4);
        }

        /* ===== BOUTON DICT√âE VOCALE ===== */
        .dictate-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%;
            padding: 12px 20px;
            margin-bottom: 20px;
            background: #f0f2f5;
            border: 1px dashed #CFD8DC;
            border-radius: 10px;
            font-family: 'Inter', sans-serif;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-dark);
            cursor: pointer;
            transition: all 0.2s;
        }
        .dictate-btn:hover { border-color: #667eea; color: #667eea; background: #f5f3ff; }
        .dictate-status.transcribing { display: block; color: #667eea; }
        .dictate-btn.recording {
            background: #FFEBEE;
            border-color: #FF4757;
            border-style: solid;
            color: #FF4757;
            animation: dictatePulse 1.2s infinite;
        }
        @keyframes dictatePulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(255, 71, 87, 0.3); }
            50% { box-shadow: 0 0 0 8px rgba(255, 71, 87, 0); }
        }
        .dictate-status {
            font-size: 12px;
            color: #FF4757;
            text-align: center;
            margin-top: -14px;
            margin-bottom: 16px;
            font-weight: 500;
            display: none;
        }
        .dictate-status.active { display: block; }

        /* ===== NOTES HORODAT√âES ===== */
        .notes-section { margin-top: 20px; border-top: 1px solid var(--border-color); padding-top: 16px; }
        .notes-section-title {
            font-family: 'Barlow Semi Condensed', sans-serif;
            font-size: 14px; font-weight: 700; text-transform: uppercase;
            color: var(--text-dark); margin-bottom: 10px;
        }
        .notes-section-title .notes-count { font-family: 'Inter', sans-serif; font-weight: 400; font-size: 12px; color: var(--text-light); text-transform: none; }
        .notes-input-row { display: flex; gap: 6px; margin-bottom: 12px; }
        .notes-textarea {
            flex: 1; padding: 8px 12px; border: 1px solid #E1E8ED; border-radius: 8px;
            font-family: 'Inter', sans-serif; font-size: 13px; color: #2C3E50;
            resize: none; outline: none; min-height: 36px; max-height: 60px; line-height: 1.4;
        }
        .notes-textarea:focus { border-color: #667eea; }
        .notes-textarea::placeholder { color: #B0BEC5; }
        .notes-mic-btn {
            padding: 8px 10px; background: #f0f2f5; border: 1px solid #E1E8ED;
            border-radius: 8px; font-size: 16px; cursor: pointer; transition: all 0.2s; flex-shrink: 0;
        }
        .notes-mic-btn:hover { background: #e8eaf6; border-color: #667eea; }
        .notes-mic-btn.transcribing { background: #E8EAF6; border-color: #667eea; }
        .notes-mic-btn.recording { background: #FFEBEE; border-color: #FF4757; animation: dictatePulse 1.2s infinite; }
        .notes-add-btn {
            padding: 8px 14px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; flex-shrink: 0;
        }
        .notes-add-btn:hover { opacity: 0.9; }
        .notes-timeline { max-height: 300px; overflow-y: auto; }
        .notes-timeline::-webkit-scrollbar { width: 4px; }
        .notes-timeline::-webkit-scrollbar-thumb { background: #CFD8DC; border-radius: 4px; }
        .note-item { padding: 10px 0; border-bottom: 1px solid #f0f0f0; position: relative; }
        .note-item:last-child { border-bottom: none; }
        .note-date { font-size: 11px; color: var(--text-light); margin-bottom: 3px; }
        .note-content { font-size: 13px; color: var(--text-dark); line-height: 1.4; word-break: break-word; }
        .note-delete-btn {
            position: absolute; top: 10px; right: 0; background: none; border: none;
            cursor: pointer; font-size: 13px; color: #CFD8DC; opacity: 0;
            transition: opacity 0.2s, color 0.2s; padding: 2px 4px;
        }
        .note-item:hover .note-delete-btn { opacity: 1; }
        .note-delete-btn:hover { color: #FF4757; }
        .notes-empty { font-size: 13px; color: var(--text-light); font-style: italic; padding: 12px 0; }
        .card-notes-preview { font-size: 12px; color: var(--text-light); font-style: italic; margin-top: 4px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .card-notes-badge { font-size: 11px; color: #667eea; background: #f0f2ff; padding: 2px 6px; border-radius: 4px; display: inline-block; }

        /* ===== MOBILE-ONLY ELEMENTS (hidden on desktop) ===== */
        .mobile-tabs { display: none; }
        .mobile-move-btn { display: none !important; }
        .move-popup-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            align-items: flex-end;
            justify-content: center;
        }
        .move-popup-overlay.active { display: flex; }
        .move-popup {
            background: white;
            border-radius: 16px 16px 0 0;
            padding: 20px;
            width: 100%;
            max-width: 500px;
            animation: slideUpPopup 0.25s ease;
        }
        @keyframes slideUpPopup {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }
        .move-popup-title {
            font-family: 'Barlow Semi Condensed', sans-serif;
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 14px;
            text-align: center;
        }
        .move-popup-option {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 14px;
            border-radius: 10px;
            border: none;
            background: #f8f9fa;
            width: 100%;
            font-size: 15px;
            font-family: 'Inter', sans-serif;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 8px;
            transition: background 0.2s;
        }
        .move-popup-option:hover { background: #e8eaf6; }
        .move-popup-cancel {
            display: block;
            width: 100%;
            padding: 14px;
            margin-top: 8px;
            border: none;
            background: #e9ecef;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 600;
            font-family: 'Inter', sans-serif;
            cursor: pointer;
            color: var(--text-light);
        }

        /* ===== RESPONSIVE MOBILE ===== */
        @media (max-width: 768px) {
            body { padding: 10px; }

            /* --- HEADER : 3 lignes --- */
            .header {
                display: grid;
                grid-template-columns: 1fr 1fr;
                grid-template-rows: auto auto auto;
                gap: 8px;
                padding: 10px 14px;
                border-radius: 12px;
                margin-bottom: 12px;
            }

            /* Ligne 1 : logo + profil */
            .logo { grid-column: 1; grid-row: 1; align-self: center; }
            .logo img { width: 60px; }

            .header-actions { display: contents; }

            .user-profile { grid-column: 2; grid-row: 1; justify-self: end; align-self: center; }
            .user-avatar { width: 32px; height: 32px; }
            .user-name { display: none; }

            /* Ligne 2 : onglets */
            .nav-tabs {
                grid-column: 1 / -1;
                grid-row: 2;
                justify-content: center;
                gap: 6px;
            }
            .nav-text { display: none; }
            .nav-tab { padding: 8px 14px; font-size: 20px; line-height: 1; }

            /* Ligne 3 : cloche + export + bouton "+" centr√©s */
            .alert-counter {
                grid-column: 1;
                grid-row: 3;
                justify-self: end;
                padding: 8px;
                gap: 4px;
                border-radius: 10px;
            }
            .alert-text { display: none; }
            .alert-icon { font-size: 20px; }

            .btn-text { display: none; }

            .export-wrapper { grid-column: 1; grid-row: 4; justify-self: end; }
            .export-btn {
                padding: 8px 14px;
                font-size: 20px;
                line-height: 1;
                border-radius: 10px;
                border-color: rgba(0,0,0,0.15);
                color: var(--text-dark);
            }
            .export-dropdown {
                right: auto;
                left: 0;
                min-width: calc(100vw - 28px);
            }

            .add-btn {
                grid-column: 2;
                grid-row: 3;
                grid-row-end: 5;
                justify-self: start;
                align-self: center;
                padding: 8px 14px;
                font-size: 20px;
                line-height: 1;
                border-radius: 10px;
                background: #2DD4BF;
                box-shadow: 0 2px 8px rgba(45, 212, 191, 0.3);
            }

            /* --- MOBILE TAB BAR --- */
            .mobile-tabs {
                display: flex;
                gap: 0;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                background: white;
                border-radius: 12px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.08);
                margin-bottom: 12px;
                position: sticky;
                top: 0;
                z-index: 50;
            }
            .mobile-tabs::-webkit-scrollbar { display: none; }

            .mobile-tab {
                flex: 1;
                flex-shrink: 0;
                padding: 10px 14px;
                border: none;
                background: none;
                font-family: 'Inter', sans-serif;
                font-size: 13px;
                font-weight: 600;
                color: #7F8C8D;
                cursor: pointer;
                white-space: nowrap;
                border-bottom: 3px solid transparent;
                transition: all 0.2s;
                text-align: center;
            }
            .mobile-tab.active {
                color: #2C3E50;
                border-bottom-color: #2DD4BF;
            }
            .mobile-tab .tab-count { font-weight: 400; }

            /* --- PIPELINE : tab-based (hide all, show active) --- */
            .pipeline {
                display: block !important;
                overflow: visible !important;
                scroll-snap-type: none !important;
            }
            .column {
                display: none !important;
                min-width: 100% !important;
                padding: 0 !important;
                min-height: auto;
            }
            .column.mobile-active {
                display: block !important;
            }
            .column.mobile-active .column-header { display: none; }
            .column.mobile-active .column-title { display: none; }
            .column.mobile-active .column-count { display: none; }

            /* --- CARTES : pleine largeur, tactiles --- */
            .lead-card {
                padding: 16px;
                border-radius: 12px;
                width: 100%;
            }
            .lead-card:hover { transform: none; }

            .card-badges { gap: 4px; margin-bottom: 8px; }
            .badge { padding: 3px 8px; font-size: 10px; }

            .card-tag { padding: 4px 8px; font-size: 10px; margin-bottom: 6px; }
            .card-name { font-size: 14px; margin-bottom: 4px; }
            .card-info { font-size: 12px; margin-bottom: 4px; line-height: 1.3; }

            .card-notes { font-size: 11px; padding: 6px; margin-top: 6px; max-height: 40px; }
            .card-links-count { font-size: 11px; }
            .card-followup { font-size: 11px; padding: 3px 6px; margin-top: 6px; }
            .badge-alert { font-size: 9px; padding: 3px 6px; }

            .card-actions { margin-top: 8px; gap: 4px; }
            .card-btn { font-size: 14px; padding: 4px; min-width: 44px; min-height: 44px; display: inline-flex; align-items: center; justify-content: center; }
            .mobile-move-btn { display: inline-flex !important; }
            .cards-container { gap: 8px; min-height: 100px; }

            /* --- MODALE : pleine largeur --- */
            .modal.active { padding: 0; align-items: flex-end; }

            .modal-content {
                max-width: 100%;
                width: 100%;
                max-height: 90vh;
                border-radius: 16px 16px 0 0;
                padding: 24px 16px;
                margin: 0;
            }

            .modal-header { margin-bottom: 16px; }
            .modal-title { font-size: 20px; }
            .form-row, .form-row-3 { grid-template-columns: 1fr; }
            .form-group { margin-bottom: 12px; }
            .form-label { font-size: 13px; }

            .form-input,
            .form-select,
            .form-textarea { padding: 10px 12px; font-size: 14px; }

            .form-section { padding: 14px; margin-bottom: 12px; }
            .form-section-title { font-size: 14px; }
            .criteria-toggle span { padding: 6px 12px; font-size: 13px; }

            .add-link-row { flex-direction: column; }
            .add-link-btn { width: 100%; text-align: center; }

            .submit-btn { padding: 14px; font-size: 15px; }
        }
    </style>
</head>
<body>
    <div class="header">
        <a href="index.html" class="logo"><img src="img/logo_200.png" alt="WAIMMO"></a>
        <nav class="nav-tabs">
            <a href="index.html" class="nav-tab">üè† <span class="nav-text">Pipeline Vendeurs</span></a>
            <a href="acquereurs.html" class="nav-tab active">üîë <span class="nav-text">Pipeline Acqu√©reurs</span></a>
        </nav>
        <div class="header-actions">
            <div id="userProfile" class="user-profile"></div>
            <div class="alert-counter" id="alertCounter">
                <span class="alert-icon">üîî</span>
                <span class="alert-text">
                    <span class="alert-number" id="alertNumber">0</span> √† relancer
                </span>
            </div>
            <div class="export-wrapper">
                <button class="export-btn" id="exportBtn">üì• <span class="btn-text">Exporter</span></button>
                <div class="export-dropdown" id="exportDropdown">
                    <button class="export-dropdown-item" onclick="exportBuyersCSV()">üì• Exporter tout</button>
                    <button class="export-dropdown-item" style="font-weight:600;color:var(--text-light);cursor:default;font-size:12px;text-transform:uppercase;letter-spacing:0.5px" disabled>Exporter la colonne‚Ä¶</button>
                    <button class="export-dropdown-item export-dropdown-sub" onclick="exportBuyersCSV('new')">üÜï Nouveaux Acqu√©reurs</button>
                    <button class="export-dropdown-item export-dropdown-sub" onclick="exportBuyersCSV('active')">üîç En Recherche Active</button>
                    <button class="export-dropdown-item export-dropdown-sub" onclick="exportBuyersCSV('bought')">üéâ Achet√©s</button>
                    <button class="export-dropdown-item export-dropdown-sub" onclick="exportBuyersCSV('lost')">‚ùå Perdus</button>
                </div>
            </div>
            <button class="add-btn" id="addBuyerBtn">+ <span class="btn-text">Ajouter un Acqu√©reur</span></button>
        </div>
    </div>

    <div class="mobile-tabs" id="mobileTabs">
        <button class="mobile-tab active" data-status="new">üÜï Nouveaux <span class="tab-count">(0)</span></button>
        <button class="mobile-tab" data-status="active">üîç Actifs <span class="tab-count">(0)</span></button>
        <button class="mobile-tab" data-status="bought">üéâ Achet√©s <span class="tab-count">(0)</span></button>
        <button class="mobile-tab" data-status="lost">‚ùå Perdus <span class="tab-count">(0)</span></button>
    </div>

    <div class="pipeline">
        <!-- Colonne Nouveaux Acqu√©reurs -->
        <div class="column" data-status="new">
            <div class="column-header header-new">
                <div class="column-label">NOUVEAUX</div>
            </div>
            <div class="column-title">Premier contact</div>
            <div class="column-count"><span>üìã</span><span class="count">0</span></div>
            <div class="cards-container" id="new-container"></div>
        </div>

        <!-- Colonne En Recherche Active -->
        <div class="column" data-status="active">
            <div class="column-header header-active">
                <div class="column-label">RECHERCHE ACTIVE</div>
            </div>
            <div class="column-title">Crit√®res d√©finis, envoi de biens</div>
            <div class="column-count"><span>üìã</span><span class="count">0</span></div>
            <div class="cards-container" id="active-container"></div>
        </div>

        <!-- Colonne Achet√©s -->
        <div class="column" data-status="bought">
            <div class="column-header header-bought">
                <div class="column-label">ACHET√âS</div>
            </div>
            <div class="column-title">Ils ont trouv√© üéâ</div>
            <div class="column-count"><span>üìã</span><span class="count">0</span></div>
            <div class="cards-container" id="bought-container"></div>
        </div>

        <!-- Colonne Perdus -->
        <div class="column" data-status="lost">
            <div class="column-header header-lost">
                <div class="column-label">PLUS EN RECHERCHE</div>
            </div>
            <div class="column-title">Abandon</div>
            <div class="column-count"><span>üìã</span><span class="count">0</span></div>
            <div class="cards-container" id="lost-container"></div>
        </div>
    </div>

    <!-- Modal Acqu√©reur -->
    <div class="modal" id="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Nouvel Acqu√©reur</h2>
                <button class="close-btn" id="closeModalBtn">&times;</button>
            </div>
            <form id="buyerForm">
                <button type="button" class="dictate-btn" id="dictateBtn">üéôÔ∏è Dicter mon lead</button>
                <div class="dictate-status" id="dictateStatus"></div>
                <!-- Section Contact -->
                <div class="form-section">
                    <div class="form-section-title">üìá Contact</div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Pr√©nom *</label>
                            <input type="text" class="form-input" id="firstName" placeholder="Jean" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Nom *</label>
                            <input type="text" class="form-input" id="lastName" placeholder="Dupont" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">T√©l√©phone</label>
                            <input type="tel" class="form-input" id="phone" placeholder="06 12 34 56 78">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-input" id="email" placeholder="jean@email.com">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Source du lead</label>
                            <select class="form-select" id="source">
                                <option value="">S√©lectionnez</option>
                                <option value="site_annonce">üåê Site d'annonce (SL, LBC, BienIci)</option>
                                <option value="efficity">üè¢ Efficity</option>
                                <option value="recommandation">ü§ù Recommandation</option>
                                <option value="appel_entrant">üìû Appel entrant</option>
                                <option value="reseaux_sociaux">üì± R√©seaux sociaux</option>
                                <option value="autre">üìå Autre</option>
                            </select>
                            <div class="referrer-group" id="referrerGroup">
                                <label class="form-label">Apporteur d'affaire</label>
                                <input type="text" class="form-input" id="referrerName" placeholder="Nom de l'apporteur..." autocomplete="off">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Section Recherche -->
                <div class="form-section">
                    <div class="form-section-title">üîç Recherche</div>
                    <div class="form-row-3">
                        <div class="form-group">
                            <label class="form-label">Type de bien *</label>
                            <select class="form-select" id="propertyType" required>
                                <option value="">S√©lectionnez</option>
                                <option value="appartement">Appartement</option>
                                <option value="maison">Maison</option>
                                <option value="terrain">Terrain</option>
                                <option value="immeuble">Immeuble</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Typologie</label>
                            <select class="form-select" id="rooms">
                                <option value="">‚Äî</option>
                                <option value="T1">T1</option>
                                <option value="T2">T2</option>
                                <option value="T3">T3</option>
                                <option value="T4">T4</option>
                                <option value="T5+">T5+</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Surface min (m¬≤)</label>
                            <input type="number" class="form-input" id="surfaceMin" placeholder="60">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Secteur / Villes *</label>
                        <input type="text" class="form-input" id="sector" placeholder="Lyon 3, Villeurbanne..." required>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Budget min (‚Ç¨)</label>
                            <input type="number" class="form-input" id="budgetMin" placeholder="200000">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Budget max (‚Ç¨)</label>
                            <input type="number" class="form-input" id="budgetMax" placeholder="350000">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Crit√®res</label>
                        <div class="criteria-toggles">
                            <label class="criteria-toggle"><input type="checkbox" name="criteria" value="jardin"><span>üåø Jardin</span></label>
                            <label class="criteria-toggle"><input type="checkbox" name="criteria" value="parking"><span>üÖøÔ∏è Parking</span></label>
                            <label class="criteria-toggle"><input type="checkbox" name="criteria" value="ascenseur"><span>üõó Ascenseur</span></label>
                            <label class="criteria-toggle"><input type="checkbox" name="criteria" value="balcon_terrasse"><span>‚òÄÔ∏è Balcon/Terrasse</span></label>
                            <label class="criteria-toggle"><input type="checkbox" name="criteria" value="calme"><span>ü§´ Calme</span></label>
                            <label class="criteria-toggle"><input type="checkbox" name="criteria" value="neuf_renove"><span>‚ú® Neuf/R√©nov√©</span></label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Surface (m¬≤)</label>
                        <input type="text" class="form-input" id="surface" placeholder="65 m¬≤">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Annexes</label>
                        <div class="criteria-toggles">
                            <label class="criteria-toggle"><input type="checkbox" name="annexes" value="parking"><span>üÖøÔ∏è Parking</span></label>
                            <label class="criteria-toggle"><input type="checkbox" name="annexes" value="cave"><span>üì¶ Cave</span></label>
                            <label class="criteria-toggle"><input type="checkbox" name="annexes" value="balcon"><span>üåø Balcon</span></label>
                            <label class="criteria-toggle"><input type="checkbox" name="annexes" value="jardin"><span>üå≥ Jardin</span></label>
                            <label class="criteria-toggle"><input type="checkbox" name="annexes" value="garage"><span>üöó Garage</span></label>
                        </div>
                    </div>
                </div>

                <!-- Section Situation -->
                <div class="form-section">
                    <div class="form-section-title">üìä Situation</div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Pr√©-accord bancaire</label>
                            <select class="form-select" id="bankApproval">
                                <option value="">‚Äî</option>
                                <option value="oui">‚úÖ Oui</option>
                                <option value="non">‚ùå Non</option>
                                <option value="en_cours">‚è≥ En cours</option>
                                <option value="ne_sait_pas">‚ùì Ne sait pas</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">D√©lai projet</label>
                            <select class="form-select" id="timeline">
                                <option value="">‚Äî</option>
                                <option value="immediat">üöÄ Imm√©diat</option>
                                <option value="court_terme">üìÖ Court terme (1-3 mois)</option>
                                <option value="moyen_terme">üìÜ Moyen terme (3-6 mois)</option>
                                <option value="long_terme">üóìÔ∏è Long terme (6 mois+)</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="seller-toggle-group">
                            <label class="toggle-switch">
                                <input type="checkbox" id="isSeller">
                                <span class="toggle-slider"></span>
                            </label>
                            <span style="font-weight:600;font-size:14px;">üè∑Ô∏è Ce prospect est aussi vendeur d'un bien</span>
                        </div>
                        <div class="seller-fields" id="sellerFields" style="display:none;">
                            <div class="form-group" style="margin-bottom:12px;">
                                <label class="form-label">Adresse du bien √† vendre</label>
                                <input type="text" class="form-input" id="sellerAddress" placeholder="123 rue de la Paix, Lyon">
                            </div>
                            <div class="form-group" style="margin-bottom:0;">
                                <label class="form-label">Prix de vente souhait√©</label>
                                <input type="text" class="form-input" id="sellerPrice" placeholder="350 000 ‚Ç¨">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Section Notes -->
                <div class="form-section">
                    <div class="form-section-title">üìù Notes</div>
                    <div class="form-group">
                        <label class="form-label">√âl√©ments r√©dhibitoires</label>
                        <textarea class="form-textarea" id="dealbreakers" placeholder="Pas de rez-de-chauss√©e, pas proche voie ferr√©e..."></textarea>
                    </div>
                    <!-- Notes horodat√©es -->
                    <div class="notes-section">
                        <div class="notes-section-title">üìù Notes <span class="notes-count" id="notesCount"></span></div>
                        <div class="notes-input-row">
                            <textarea class="notes-textarea" id="noteInput" placeholder="Ajouter une note..." rows="2"></textarea>
                            <button type="button" class="notes-mic-btn" id="noteMicBtn" title="Dict√©e vocale">üéôÔ∏è</button>
                            <button type="button" class="notes-add-btn" id="noteAddBtn">‚ûï</button>
                        </div>
                        <div class="notes-timeline" id="notesTimeline">
                            <div class="notes-empty">Aucune note pour le moment</div>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Date de relance</label>
                            <input type="date" class="form-input" id="reminder">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Colonne</label>
                            <select class="form-select" id="status">
                                <option value="new">üÜï Nouveaux Acqu√©reurs</option>
                                <option value="active">üîç En Recherche Active</option>
                                <option value="bought">üéâ Achet√©s</option>
                                <option value="lost">‚ùå Perdus</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Section Biens Propos√©s -->
                <div class="form-section">
                    <div class="form-section-title">üè† Biens Propos√©s</div>
                    <div class="links-section" id="linksContainer"></div>
                    <div class="add-link-row">
                        <input type="url" id="newLinkUrl" placeholder="Coller l'URL d'une annonce..." class="form-input">
                        <button type="button" class="add-link-btn" id="addLinkBtn">+ Ajouter</button>
                    </div>
                </div>

                <button type="button" class="submit-btn" id="submitBtn">Cr√©er l'Acqu√©reur</button>
            </form>
        </div>
    </div>

    <script>
        // ===== DONN√âES =====
        let buyers = [];
        let currentLinks = [];
        let draggedCard = null;

        // ===== MOBILE TABS =====
        const BUYER_TABS = [
            { status: 'new', icon: 'üÜï', label: 'Nouveaux' },
            { status: 'active', icon: 'üîç', label: 'Actifs' },
            { status: 'bought', icon: 'üéâ', label: 'Achet√©s' },
            { status: 'lost', icon: '‚ùå', label: 'Perdus' }
        ];
        let mobileActiveTab = localStorage.getItem('waimmo_mobile_tab_buyers') || 'new';

        function isMobile() { return window.innerWidth <= 768; }

        function setMobileTab(status) {
            mobileActiveTab = status;
            localStorage.setItem('waimmo_mobile_tab_buyers', status);
            document.querySelectorAll('.mobile-tab').forEach(t => {
                t.classList.toggle('active', t.dataset.status === status);
            });
            document.querySelectorAll('.column').forEach(c => {
                c.classList.toggle('mobile-active', c.dataset.status === status);
            });
            // Scroll tab into view
            const activeTab = document.querySelector(`.mobile-tab[data-status="${status}"]`);
            if (activeTab) activeTab.scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' });
        }

        function updateMobileTabCounts() {
            BUYER_TABS.forEach(tab => {
                const count = buyers.filter(b => b.status === tab.status).length;
                const btn = document.querySelector(`.mobile-tab[data-status="${tab.status}"] .tab-count`);
                if (btn) btn.textContent = `(${count})`;
            });
        }

        function initMobileTabs() {
            // Tab clicks
            document.querySelectorAll('.mobile-tab').forEach(tab => {
                tab.addEventListener('click', () => setMobileTab(tab.dataset.status));
            });
            // Swipe detection
            let touchStartX = 0, touchStartY = 0;
            const pipeline = document.querySelector('.pipeline');
            if (pipeline) {
                pipeline.addEventListener('touchstart', e => {
                    touchStartX = e.changedTouches[0].screenX;
                    touchStartY = e.changedTouches[0].screenY;
                }, { passive: true });
                pipeline.addEventListener('touchend', e => {
                    if (!isMobile()) return;
                    const dx = e.changedTouches[0].screenX - touchStartX;
                    const dy = e.changedTouches[0].screenY - touchStartY;
                    if (Math.abs(dx) > 50 && Math.abs(dx) > Math.abs(dy) * 1.5) {
                        const statuses = BUYER_TABS.map(t => t.status);
                        const idx = statuses.indexOf(mobileActiveTab);
                        if (dx < 0 && idx < statuses.length - 1) setMobileTab(statuses[idx + 1]);
                        else if (dx > 0 && idx > 0) setMobileTab(statuses[idx - 1]);
                    }
                }, { passive: true });
            }
            // Move popup close handlers
            document.getElementById('movePopupCancel').addEventListener('click', closeMovePopup);
            document.getElementById('movePopup').addEventListener('click', e => {
                if (e.target === e.currentTarget) closeMovePopup();
            });
            // Set initial tab
            setMobileTab(mobileActiveTab);
        }

        function openMovePopup(buyerId) {
            const buyer = buyers.find(b => b.id === buyerId);
            if (!buyer) return;
            const container = document.getElementById('movePopupOptions');
            container.innerHTML = '';
            BUYER_TABS.filter(t => t.status !== buyer.status).forEach(tab => {
                const btn = document.createElement('button');
                btn.className = 'move-popup-option';
                btn.innerHTML = `<span>${tab.icon}</span> ${tab.label}`;
                btn.addEventListener('click', () => moveBuyer(buyerId, tab.status));
                container.appendChild(btn);
            });
            document.getElementById('movePopup').classList.add('active');
        }

        function closeMovePopup() {
            document.getElementById('movePopup').classList.remove('active');
        }

        async function moveBuyer(buyerId, newStatus) {
            closeMovePopup();
            const buyer = buyers.find(b => b.id === buyerId);
            if (!buyer) return;
            buyer.status = newStatus;
            await updateBuyer(buyerId, { status: newStatus });
            renderBuyers();
            setMobileTab(newStatus);
        }

        // ===== AUTH HELPER =====
        async function getCurrentUserId() {
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (!session) { window.location.href = 'login.html'; return null; }
            return session.user.id;
        }

        // ===== CONFIG BADGES =====
        const TYPE_CONFIG = {
            appartement: { label: 'Appart.', icon: 'üè¢', cls: 'badge-type-appartement' },
            maison: { label: 'Maison', icon: 'üè°', cls: 'badge-type-maison' },
            terrain: { label: 'Terrain', icon: 'üå≥', cls: 'badge-type-terrain' },
            immeuble: { label: 'Immeuble', icon: 'üèõÔ∏è', cls: 'badge-type-immeuble' }
        };

        // ===== HELPERS =====
        function formatBudget(min, max) {
            if (min && max) return formatEuro(min) + ' - ' + formatEuro(max);
            if (max) return '< ' + formatEuro(max);
            if (min) return '> ' + formatEuro(min);
            return '';
        }

        function detectPlatform(url) {
            if (url.includes('seloger.com')) return { name: 'SeLoger', icon: 'üè†' };
            if (url.includes('leboncoin.fr')) return { name: 'LeBonCoin', icon: 'üü†' };
            if (url.includes('bienici.com')) return { name: 'BienIci', icon: 'üîµ' };
            if (url.includes('efficity.com')) return { name: 'Efficity', icon: 'üè¢' };
            if (url.includes('logic-immo.com')) return { name: 'Logic-Immo', icon: 'üèòÔ∏è' };
            if (url.includes('pap.fr')) return { name: 'PAP', icon: 'üì∞' };
            return { name: 'Lien', icon: 'üîó' };
        }

        function getFollowupHTML(reminder) {
            if (!reminder) return { html: '', isAlert: false };
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const reminderDate = new Date(reminder);
            reminderDate.setHours(0, 0, 0, 0);
            const diffDays = Math.ceil((reminderDate - today) / (1000 * 60 * 60 * 24));
            const formatted = reminderDate.toLocaleDateString('fr-FR', { day: '2-digit', month: 'short' });

            if (diffDays < 0) return { html: `<div class="card-followup followup-overdue">‚ö†Ô∏è Relance en retard (${formatted})</div>`, isAlert: true };
            if (diffDays === 0) return { html: `<div class="card-followup followup-due">üîî √Ä relancer aujourd'hui</div>`, isAlert: true };
            if (diffDays <= 3) return { html: `<div class="card-followup followup-due">üìÖ Relance ${formatted}</div>`, isAlert: false };
            return { html: `<div class="card-followup followup-ok">üìÖ Relance ${formatted}</div>`, isAlert: false };
        }

        // ===== SUPABASE CRUD =====
        async function loadBuyers() {
            const userId = await getCurrentUserId();
            if (!userId) return;
            const { data, error } = await supabaseClient
                .from('buyers')
                .select('*')
                .eq('user_id', userId)
                .order('created_at', { ascending: false });
            if (error) { console.error('Erreur chargement:', error); return; }
            buyers = data || [];
            await loadBuyerNotePreviews();
            renderBuyers();
        }

        async function createBuyer(buyer) {
            const userId = await getCurrentUserId();
            if (!userId) return null;
            buyer.user_id = userId;
            const { data, error } = await supabaseClient.from('buyers').insert([buyer]).select();
            if (error) { console.error('Erreur cr√©ation:', error); alert('Erreur lors de la cr√©ation.'); return null; }
            return data[0];
        }

        async function updateBuyer(id, updates) {
            const userId = await getCurrentUserId();
            if (!userId) return null;
            updates.updated_at = new Date().toISOString();
            const { data, error } = await supabaseClient.from('buyers').update(updates).eq('id', id).eq('user_id', userId).select();
            if (error) { console.error('Erreur mise √† jour:', error); alert('Erreur lors de la mise √† jour.'); return null; }
            return data[0];
        }

        async function deleteBuyerDB(id) {
            const userId = await getCurrentUserId();
            if (!userId) return false;
            const { error } = await supabaseClient.from('buyers').delete().eq('id', id).eq('user_id', userId);
            if (error) { console.error('Erreur suppression:', error); alert('Erreur lors de la suppression.'); return false; }
            return true;
        }

        // ===== RENDU =====
        function renderBuyers() {
            const containers = {
                new: document.getElementById('new-container'),
                active: document.getElementById('active-container'),
                bought: document.getElementById('bought-container'),
                lost: document.getElementById('lost-container')
            };

            Object.values(containers).forEach(c => { if (c) c.innerHTML = ''; });

            buyers.forEach(buyer => {
                const card = createBuyerCard(buyer);
                if (containers[buyer.status]) {
                    containers[buyer.status].appendChild(card);
                }
            });

            updateCounts();
        }

        function getBuyerPropertyLine(buyer) {
            const parts = [];
            const typeEmojis = { appartement: 'üè¢', maison: 'üè°', terrain: 'üèóÔ∏è', immeuble: 'üèõÔ∏è' };
            if (buyer.property_type) parts.push(typeEmojis[buyer.property_type] || 'üìç');
            if (buyer.surface) parts.push(buyer.surface);
            const annexeEmojis = { parking: 'üÖøÔ∏è', cave: 'üì¶', balcon: 'üåø', jardin: 'üå≥', garage: 'üöó' };
            if (Array.isArray(buyer.annexes) && buyer.annexes.length > 0) {
                parts.push(buyer.annexes.map(a => annexeEmojis[a] || '').filter(Boolean).join(' '));
            }
            if (parts.length === 0) return '';
            return `<div class="card-info" style="font-size:13px;color:#546E7A;font-weight:500">${parts.join(' ¬∑ ')}</div>`;
        }

        function createBuyerCard(buyer) {
            const card = document.createElement('div');
            card.className = 'lead-card';
            card.draggable = true;
            card.dataset.id = buyer.id;

            const followup = getFollowupHTML(buyer.reminder);
            let html = '';

            if (followup.isAlert) {
                html += '<div class="badge-alert">√Ä RELANCER</div>';
            }

            // Badges visuels
            html += '<div class="card-badges">';
            if (buyer.property_type) {
                const tc = TYPE_CONFIG[buyer.property_type];
                if (tc) html += `<span class="badge ${tc.cls}">${tc.icon} ${tc.label}</span>`;
            }
            if (buyer.rooms) {
                html += `<span class="badge badge-rooms">${buyer.rooms}</span>`;
            }
            if (buyer.sector) {
                html += `<span class="badge badge-sector">üìç ${buyer.sector}</span>`;
            }
            const budgetLabel = formatBudget(buyer.budget_min, buyer.budget_max);
            if (budgetLabel) {
                html += `<span class="badge badge-budget">üí∞ ${budgetLabel}</span>`;
            }
            if (buyer.is_seller) {
                html += '<span class="badge badge-seller">üè∑Ô∏è Vendeur</span>';
            }
            html += '</div>';

            // Source tag
            if (buyer.source) {
                html += getBuyerSourceTag(buyer.source);
                if (buyer.source === 'recommandation' && buyer.referrer_name) {
                    html += `<div class="referrer-via">via ${escapeHtml(buyer.referrer_name)}</div>`;
                }
            }

            // Infos principales
            html += `<div class="card-name">${buyer.first_name} ${buyer.last_name}</div>`;
            html += getBuyerPropertyLine(buyer);
            if (buyer.phone) html += `<div class="card-info">üìû ${buyer.phone}</div>`;
            if (buyer.email) html += `<div class="card-info">üìß ${buyer.email}</div>`;

            // Notes horodat√©es
            const np = notesPreviews[buyer.id];
            if (np && np.count > 0) {
                html += `<span class="card-notes-badge">üìù ${np.count}</span>`;
                const preview = np.lastContent.length > 50 ? np.lastContent.substring(0, 50) + '‚Ä¶' : np.lastContent;
                html += `<div class="card-notes-preview">üí¨ ${escapeHtml(preview)}</div>`;
            }

            // Compteur de liens
            const links = buyer.links || [];
            if (links.length > 0) {
                html += `<div class="card-links-count">üè† ${links.length} bien${links.length > 1 ? 's' : ''} propos√©${links.length > 1 ? 's' : ''}</div>`;
            }

            // Relance
            html += followup.html;

            // Actions
            html += `<div class="card-actions">
                <button class="card-btn mobile-move-btn" onclick="openMovePopup('${buyer.id}')" title="D√©placer">üìÇ</button>
                <button class="card-btn" onclick="editBuyer('${buyer.id}')" title="Modifier">‚úèÔ∏è</button>
                <button class="card-btn" onclick="confirmDeleteBuyer('${buyer.id}')" title="Supprimer">üóëÔ∏è</button>
            </div>`;

            card.innerHTML = html;
            return card;
        }

        function updateCounts() {
            const statuses = ['new', 'active', 'bought', 'lost'];
            statuses.forEach(status => {
                const count = buyers.filter(b => b.status === status).length;
                const col = document.querySelector(`.column[data-status="${status}"] .count`);
                if (col) col.textContent = count;
            });
            updateAlertCounter();
            updateMobileTabCounts();
        }

        function updateAlertCounter() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const count = buyers.filter(b => {
                if (!b.reminder) return false;
                const d = new Date(b.reminder);
                d.setHours(0, 0, 0, 0);
                return d <= today;
            }).length;

            document.getElementById('alertNumber').textContent = count;
            const el = document.getElementById('alertCounter');
            if (count > 0) el.classList.add('has-alerts');
            else el.classList.remove('has-alerts');
        }

        // ===== MODAL =====
        let formModified = false;
        let isNewLead = true;
        let originalFormValues = {};

        function getFormValues() {
            const vals = {};
            document.getElementById('modal').querySelectorAll('input, textarea, select').forEach(el => {
                if (el.type === 'checkbox') vals[el.id || el.name] = el.checked;
                else vals[el.id || el.name] = el.value;
            });
            return vals;
        }

        function canCloseWithoutConfirm() {
            if (isNewLead) {
                return !formModified;
            } else {
                const current = getFormValues();
                return JSON.stringify(current) === JSON.stringify(originalFormValues);
            }
        }

        function openModal() {
            formModified = false;
            const submitBtn = document.getElementById('submitBtn');
            isNewLead = !submitBtn.dataset.editId;

            document.getElementById('modal').classList.add('active');
            document.body.style.overflow = 'hidden';

            setTimeout(() => { originalFormValues = getFormValues(); }, 100);
        }

        function closeModal(skipConfirm) {
            if (!skipConfirm && !canCloseWithoutConfirm()) {
                const msg = isNewLead ? 'Lead non enregistr√©. Fermer ?' : 'Modifications non enregistr√©es. Fermer ?';
                if (!confirm(msg)) return;
            }
            formModified = false;
            isNewLead = true;
            originalFormValues = {};
            document.getElementById('modal').classList.remove('active');
            document.body.style.overflow = 'auto';
            resetForm();
        }

        function resetForm() {
            document.getElementById('buyerForm').reset();
            document.getElementById('sellerFields').style.display = 'none';
            document.getElementById('referrerGroup').classList.remove('active');
            document.getElementById('referrerName').value = '';
            currentLinks = [];
            renderLinks();
            if (buyerRecorder) buyerRecorder.stop();
            // Reset notes
            currentNotes = [];
            renderBuyerNotes();
            if (noteRecorder) noteRecorder.stop();
            document.getElementById('noteInput').value = '';
            const btn = document.getElementById('submitBtn');
            delete btn.dataset.editId;
            btn.textContent = "Cr√©er l'Acqu√©reur";
            document.querySelector('.modal-title').textContent = 'Nouvel Acqu√©reur';
        }

        // ===== DICT√âE VOCALE MODALE =====
        // ===== DICT√âE VOCALE MODALE (MediaRecorder + Whisper) =====
        let buyerRecorder = null;

        async function handleBuyerDictateClick() {
            const btn = document.getElementById('dictateBtn');
            const status = document.getElementById('dictateStatus');

            if (buyerRecorder && buyerRecorder.isRecording) {
                buyerRecorder.stop();
                return;
            }

            // getUserMedia DIRECT ‚Äî iOS Safari exige que ce soit le 1er await sans wrapper async
            let stream;
            try {
                stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            } catch (err) {
                console.warn('getUserMedia error:', err.name, err.message);
                const msg = (err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError')
                    ? 'Micro bloqu√© ‚Äî autorisez le micro dans les r√©glages Safari'
                    : 'Impossible d\'acc√©der au micro';
                status.textContent = '‚ö†Ô∏è ' + msg;
                status.className = 'dictate-status active';
                setTimeout(() => { status.className = 'dictate-status'; }, 4000);
                return;
            }

            buyerRecorder = new AudioRecorder({
                maxDuration: 30000,
                silenceTimeout: 5000,
                onStateChange: (state, msg) => {
                    if (state === 'recording') {
                        btn.classList.add('recording');
                        btn.innerHTML = '‚èπÔ∏è Arr√™ter la dict√©e';
                        status.textContent = 'üî¥ √âcoute en cours‚Ä¶ Parlez naturellement.';
                        status.className = 'dictate-status active';
                    } else if (state === 'transcribing') {
                        btn.classList.remove('recording');
                        btn.innerHTML = '‚è≥ Transcription...';
                        status.textContent = '‚è≥ Transcription en cours...';
                        status.className = 'dictate-status active transcribing';
                    } else if (state === 'error') {
                        btn.classList.remove('recording');
                        btn.innerHTML = 'üéôÔ∏è Dicter mon lead';
                        if (msg) {
                            status.textContent = '‚ö†Ô∏è ' + msg;
                            status.className = 'dictate-status active';
                            setTimeout(() => { status.className = 'dictate-status'; }, 4000);
                        } else {
                            status.className = 'dictate-status';
                        }
                    } else {
                        btn.classList.remove('recording');
                        btn.innerHTML = 'üéôÔ∏è Dicter mon lead';
                        status.className = 'dictate-status';
                    }
                }
            });

            try {
                const text = await buyerRecorder.record(stream);
                if (text && text.trim()) {
                    console.log('Dict√©e transcrite:', text.trim());
                    await parseBuyerDictation(text.trim(), btn, status);
                }
            } catch (err) {
                console.error('Buyer dictation error:', err);
            }
        }

        async function parseBuyerDictation(text, btn, statusEl) {
            // Show parsing state
            if (btn) btn.innerHTML = 'üß† Analyse...';
            if (statusEl) {
                statusEl.textContent = 'üß† Analyse des informations...';
                statusEl.className = 'dictate-status active transcribing';
            }

            try {
                const resp = await fetch('/api/parse-lead', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text, type: 'buyer' })
                });

                if (!resp.ok) throw new Error('Erreur analyse');
                const { fields } = await resp.json();
                console.log('Champs extraits par Claude:', fields);

                // Map fields ‚Äî ONLY fill if value is not null
                if (fields.first_name) document.getElementById('firstName').value = fields.first_name;
                if (fields.last_name) document.getElementById('lastName').value = fields.last_name;
                if (fields.phone) document.getElementById('phone').value = fields.phone;
                if (fields.email) document.getElementById('email').value = fields.email;

                // Source select
                if (fields.source) {
                    const sourceSelect = document.getElementById('source');
                    for (let option of sourceSelect.options) {
                        if (option.value.toLowerCase() === fields.source.toLowerCase()) {
                            sourceSelect.value = option.value;
                            break;
                        }
                    }
                    // Show referrer field if recommandation
                    const rg = document.getElementById('referrerGroup');
                    if (fields.source.toLowerCase() === 'recommandation') {
                        rg.classList.add('active');
                        if (fields.referrer_name) {
                            document.getElementById('referrerName').value = fields.referrer_name;
                        }
                    } else {
                        rg.classList.remove('active');
                    }
                }

                // Property type select
                if (fields.property_type) {
                    const ptSelect = document.getElementById('propertyType');
                    for (let option of ptSelect.options) {
                        if (option.value.toLowerCase() === fields.property_type.toLowerCase()) {
                            ptSelect.value = option.value;
                            break;
                        }
                    }
                }

                // Rooms select
                if (fields.rooms) {
                    const roomsSelect = document.getElementById('rooms');
                    for (let option of roomsSelect.options) {
                        if (option.value === fields.rooms) {
                            roomsSelect.value = option.value;
                            break;
                        }
                    }
                }

                if (fields.sector) document.getElementById('sector').value = fields.sector;
                if (fields.surface_min) document.getElementById('surfaceMin').value = fields.surface_min;
                if (fields.budget_min) document.getElementById('budgetMin').value = fields.budget_min;
                if (fields.budget_max) document.getElementById('budgetMax').value = fields.budget_max;

                // Criteria checkboxes
                if (Array.isArray(fields.criteria) && fields.criteria.length > 0) {
                    fields.criteria.forEach(c => {
                        const cb = document.querySelector(`input[name="criteria"][value="${c}"]`);
                        if (cb) cb.checked = true;
                    });
                }

                if (fields.dealbreakers) document.getElementById('dealbreakers').value = fields.dealbreakers;

                // Surface
                if (fields.surface) {
                    const surfaceInput = document.getElementById('surface');
                    if (surfaceInput) surfaceInput.value = fields.surface;
                }

                // Annexes
                if (Array.isArray(fields.annexes) && fields.annexes.length > 0) {
                    fields.annexes.forEach(a => {
                        const cb = document.querySelector(`input[name="annexes"][value="${a}"]`);
                        if (cb) cb.checked = true;
                    });
                }

                // Bank approval select
                if (fields.bank_approval) {
                    const baSelect = document.getElementById('bankApproval');
                    for (let option of baSelect.options) {
                        if (option.value === fields.bank_approval) {
                            baSelect.value = option.value;
                            break;
                        }
                    }
                }

                // Timeline select
                if (fields.timeline) {
                    const tlSelect = document.getElementById('timeline');
                    for (let option of tlSelect.options) {
                        if (option.value === fields.timeline) {
                            tlSelect.value = option.value;
                            break;
                        }
                    }
                }

                // Status select
                if (fields.status) {
                    const statusSelect = document.getElementById('status');
                    for (let option of statusSelect.options) {
                        if (option.value.toLowerCase() === fields.status.toLowerCase()) {
                            statusSelect.value = option.value;
                            break;
                        }
                    }
                }

                // Reminder date
                if (fields.reminder) document.getElementById('reminder').value = fields.reminder;

                // Notes uniquement si Claude a extrait une info compl√©mentaire
                if (fields.notes) {
                    const noteInput = document.getElementById('noteInput');
                    if (noteInput) noteInput.value = fields.notes;
                }

                if (statusEl) {
                    statusEl.textContent = '‚úÖ Champs remplis !';
                    statusEl.className = 'dictate-status active';
                    setTimeout(() => { statusEl.className = 'dictate-status'; }, 3000);
                }
            } catch (err) {
                console.error('Parse error:', err);
                if (statusEl) {
                    statusEl.textContent = '‚ö†Ô∏è Analyse √©chou√©e';
                    statusEl.className = 'dictate-status active';
                    setTimeout(() => { statusEl.className = 'dictate-status'; }, 4000);
                }
            }

            if (btn) btn.innerHTML = 'üéôÔ∏è Dicter mon lead';
        }

        // ===== NOTES HORODAT√âES =====
        let currentNotes = [];
        let noteRecorder = null;

        async function loadBuyerNotes(buyerId) {
            const userId = await getCurrentUserId();
            if (!userId || !buyerId) { currentNotes = []; renderBuyerNotes(); return; }
            const { data, error } = await supabaseClient
                .from('lead_notes')
                .select('*')
                .eq('user_id', userId)
                .eq('buyer_id', buyerId)
                .order('created_at', { ascending: false });
            if (error) { console.error('Notes load error:', error); return; }
            currentNotes = data || [];
            renderBuyerNotes();
        }

        async function addBuyerNote(buyerId) {
            const input = document.getElementById('noteInput');
            const text = input.value.trim();
            if (!text) return;
            if (!buyerId) { alert('Enregistrez le lead avant d\'ajouter des notes.'); return; }
            const userId = await getCurrentUserId();
            if (!userId) return;
            const { data, error } = await supabaseClient
                .from('lead_notes')
                .insert({ user_id: userId, buyer_id: buyerId, content: text })
                .select()
                .single();
            if (error) { console.error('Note insert error:', error); return; }
            currentNotes.unshift(data);
            input.value = '';
            renderBuyerNotes();
        }

        async function deleteBuyerNote(noteId) {
            if (!confirm('Supprimer cette note ?')) return;
            const { error } = await supabaseClient.from('lead_notes').delete().eq('id', noteId);
            if (error) { console.error('Note delete error:', error); return; }
            currentNotes = currentNotes.filter(n => n.id !== noteId);
            renderBuyerNotes();
        }

        function formatNoteDate(isoStr) {
            const d = new Date(isoStr);
            const months = ['janv.','f√©v.','mars','avr.','mai','juin','juil.','ao√ªt','sept.','oct.','nov.','d√©c.'];
            return `${d.getDate()} ${months[d.getMonth()]} ${d.getFullYear()} √† ${d.getHours()}h${String(d.getMinutes()).padStart(2,'0')}`;
        }

        function renderBuyerNotes() {
            const timeline = document.getElementById('notesTimeline');
            const countEl = document.getElementById('notesCount');
            countEl.textContent = currentNotes.length > 0 ? `(${currentNotes.length})` : '';
            if (currentNotes.length === 0) {
                timeline.innerHTML = '<div class="notes-empty">Aucune note pour le moment</div>';
                return;
            }
            timeline.innerHTML = currentNotes.map(n => `
                <div class="note-item" data-id="${n.id}">
                    <div class="note-date">${formatNoteDate(n.created_at)}</div>
                    <div class="note-content">${escapeHtml(n.content)}</div>
                    <button type="button" class="note-delete-btn" onclick="deleteBuyerNote('${n.id}')" title="Supprimer">üóëÔ∏è</button>
                </div>
            `).join('');
        }

        async function startBuyerNoteRecording() {
            const btn = document.getElementById('noteMicBtn');
            const input = document.getElementById('noteInput');

            if (noteRecorder && noteRecorder.isRecording) {
                noteRecorder.stop();
                return;
            }

            // getUserMedia DIRECT ‚Äî iOS Safari exige que ce soit le 1er await sans wrapper async
            let stream;
            try {
                stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            } catch (err) {
                console.warn('getUserMedia error:', err.name, err.message);
                alert('Micro bloqu√© ‚Äî autorisez le micro dans les r√©glages');
                return;
            }

            noteRecorder = new AudioRecorder({
                maxDuration: 30000,
                silenceTimeout: 5000,
                onStateChange: (state, msg) => {
                    if (state === 'recording') {
                        btn.classList.add('recording');
                        btn.classList.remove('transcribing');
                    } else if (state === 'transcribing') {
                        btn.classList.remove('recording');
                        btn.classList.add('transcribing');
                        btn.innerHTML = '‚è≥';
                    } else {
                        btn.classList.remove('recording', 'transcribing');
                        btn.innerHTML = 'üéôÔ∏è';
                    }
                    if (state === 'error' && msg) alert(msg);
                }
            });

            try {
                const text = await noteRecorder.record(stream);
                if (text) {
                    const current = input.value.trim();
                    input.value = current ? current + ' ' + text : text;
                }
            } catch (err) {
                console.error('Note recording error:', err);
            }
        }

        // Note previews for cards
        let notesPreviews = {};

        async function loadBuyerNotePreviews() {
            const userId = await getCurrentUserId();
            if (!userId || buyers.length === 0) { notesPreviews = {}; return; }
            const { data, error } = await supabaseClient
                .from('lead_notes')
                .select('buyer_id, content, created_at')
                .eq('user_id', userId)
                .in('buyer_id', buyers.map(b => b.id))
                .order('created_at', { ascending: false });
            if (error || !data) { notesPreviews = {}; return; }
            notesPreviews = {};
            data.forEach(n => {
                if (!notesPreviews[n.buyer_id]) notesPreviews[n.buyer_id] = { count: 0, lastContent: n.content };
                notesPreviews[n.buyer_id].count++;
            });
        }

        // ===== LIENS =====
        function renderLinks() {
            const container = document.getElementById('linksContainer');
            container.innerHTML = '';
            currentLinks.forEach((link, i) => {
                const platform = detectPlatform(link.url);
                const item = document.createElement('div');
                item.className = 'link-item';
                item.innerHTML = `
                    <span class="link-platform">${platform.icon}</span>
                    <a href="${link.url}" target="_blank" class="link-url" title="${link.url}">${platform.name}: ${link.url.replace(/https?:\/\/(www\.)?/, '').substring(0, 40)}...</a>
                    <select class="link-status-select" data-index="${i}" onchange="updateLinkStatus(${i}, this.value)">
                        <option value="proposed" ${link.status === 'proposed' ? 'selected' : ''}>üì§ Propos√©</option>
                        <option value="visited" ${link.status === 'visited' ? 'selected' : ''}>üëÄ Visit√©</option>
                        <option value="interested" ${link.status === 'interested' ? 'selected' : ''}>‚ù§Ô∏è Int√©ress√©</option>
                        <option value="refused" ${link.status === 'refused' ? 'selected' : ''}>üëé Refus√©</option>
                    </select>
                    <button class="link-delete-btn" onclick="removeLink(${i})">üóëÔ∏è</button>
                `;
                container.appendChild(item);
            });
        }

        function addLink() {
            const input = document.getElementById('newLinkUrl');
            const url = input.value.trim();
            if (!url) return;
            currentLinks.push({ url, status: 'proposed', added_at: new Date().toISOString().split('T')[0] });
            input.value = '';
            renderLinks();
        }

        function updateLinkStatus(index, status) {
            if (currentLinks[index]) currentLinks[index].status = status;
        }

        function removeLink(index) {
            currentLinks.splice(index, 1);
            renderLinks();
        }

        // ===== EDIT =====
        function editBuyer(id) {
            const buyer = buyers.find(b => b.id === id);
            if (!buyer) return;

            document.getElementById('firstName').value = buyer.first_name || '';
            document.getElementById('lastName').value = buyer.last_name || '';
            document.getElementById('phone').value = buyer.phone || '';
            document.getElementById('email').value = buyer.email || '';
            document.getElementById('source').value = buyer.source || '';
            // Referrer field
            const referrerGroup = document.getElementById('referrerGroup');
            const referrerInput = document.getElementById('referrerName');
            if (buyer.source === 'recommandation') {
                referrerGroup.classList.add('active');
                referrerInput.value = buyer.referrer_name || '';
            } else {
                referrerGroup.classList.remove('active');
                referrerInput.value = '';
            }
            document.getElementById('propertyType').value = buyer.property_type || '';
            document.getElementById('rooms').value = buyer.rooms || '';
            document.getElementById('surfaceMin').value = buyer.surface_min || '';
            const sectorInput = document.getElementById('sector');
            sectorInput.value = buyer.sector || '';
            sectorInput.dataset.latitude = buyer.latitude || '';
            sectorInput.dataset.longitude = buyer.longitude || '';
            sectorInput.dataset.city = buyer.city || '';
            sectorInput.dataset.postalCode = buyer.postal_code || '';
            document.getElementById('budgetMin').value = buyer.budget_min || '';
            document.getElementById('budgetMax').value = buyer.budget_max || '';
            document.getElementById('bankApproval').value = buyer.bank_approval || '';
            document.getElementById('timeline').value = buyer.timeline || '';
            document.getElementById('dealbreakers').value = buyer.dealbreakers || '';
            document.getElementById('reminder').value = buyer.reminder || '';
            document.getElementById('status').value = buyer.status || 'new';

            // Crit√®res
            document.querySelectorAll('input[name="criteria"]').forEach(cb => {
                cb.checked = (buyer.criteria || []).includes(cb.value);
            });

            // Surface & Annexes
            document.getElementById('surface').value = buyer.surface || '';
            document.querySelectorAll('input[name="annexes"]').forEach(cb => {
                cb.checked = (buyer.annexes || []).includes(cb.value);
            });

            // Vendeur toggle
            const isSeller = buyer.is_seller || false;
            document.getElementById('isSeller').checked = isSeller;
            document.getElementById('sellerFields').style.display = isSeller ? 'block' : 'none';
            document.getElementById('sellerAddress').value = buyer.seller_address || '';
            document.getElementById('sellerPrice').value = buyer.seller_price || '';

            // Liens
            currentLinks = JSON.parse(JSON.stringify(buyer.links || []));
            renderLinks();

            // Mode √©dition
            const btn = document.getElementById('submitBtn');
            btn.dataset.editId = id;
            btn.textContent = 'Mettre √† jour';
            document.querySelector('.modal-title').textContent = "Modifier l'Acqu√©reur";

            openModal();

            // Load notes
            loadBuyerNotes(id);
        }

        async function confirmDeleteBuyer(id) {
            if (!confirm('Supprimer cet acqu√©reur ?')) return;
            const ok = await deleteBuyerDB(id);
            if (ok) {
                buyers = buyers.filter(b => b.id !== id);
                renderBuyers();
            }
        }

        // ===== SOUMISSION =====
        async function handleSubmit() {
            const firstName = document.getElementById('firstName').value.trim();
            const lastName = document.getElementById('lastName').value.trim();
            const propertyType = document.getElementById('propertyType').value;
            const sector = document.getElementById('sector').value.trim();

            if (!firstName || !lastName || !propertyType || !sector) {
                alert('Veuillez remplir les champs obligatoires (*)');
                return;
            }

            const criteria = Array.from(document.querySelectorAll('input[name="criteria"]:checked')).map(cb => cb.value);
            const annexes = Array.from(document.querySelectorAll('input[name="annexes"]:checked')).map(cb => cb.value);

            const sectorInput = document.getElementById('sector');
            const buyerData = {
                first_name: firstName,
                last_name: lastName,
                phone: document.getElementById('phone').value.trim(),
                email: document.getElementById('email').value.trim(),
                source: document.getElementById('source').value || null,
                referrer_name: document.getElementById('source').value === 'recommandation' ? (document.getElementById('referrerName').value.trim() || null) : null,
                property_type: propertyType,
                rooms: document.getElementById('rooms').value || null,
                sector,
                latitude: parseFloat(sectorInput.dataset.latitude) || null,
                longitude: parseFloat(sectorInput.dataset.longitude) || null,
                city: sectorInput.dataset.city || null,
                postal_code: sectorInput.dataset.postalCode || null,
                surface_min: parseInt(document.getElementById('surfaceMin').value) || null,
                budget_min: parseInt(document.getElementById('budgetMin').value) || null,
                budget_max: parseInt(document.getElementById('budgetMax').value) || null,
                criteria,
                surface: document.getElementById('surface').value.trim() || null,
                annexes,
                bank_approval: document.getElementById('bankApproval').value || null,
                timeline: document.getElementById('timeline').value || null,
                is_seller: document.getElementById('isSeller').checked,
                seller_address: document.getElementById('sellerAddress').value.trim() || null,
                seller_price: document.getElementById('sellerPrice').value.trim() || null,
                dealbreakers: document.getElementById('dealbreakers').value.trim() || null,
                reminder: document.getElementById('reminder').value || null,
                status: document.getElementById('status').value,
                links: currentLinks
            };

            const editId = document.getElementById('submitBtn').dataset.editId;

            if (editId) {
                const updated = await updateBuyer(editId, buyerData);
                if (updated) {
                    const idx = buyers.findIndex(b => b.id === editId);
                    if (idx !== -1) buyers[idx] = updated;
                }
            } else {
                const created = await createBuyer(buyerData);
                if (created) buyers.unshift(created);
            }

            await loadBuyerNotePreviews();
            renderBuyers();
            formModified = false;
            closeModal(true);
        }

        // ===== DRAG & DROP =====
        function setupDragAndDrop() {
            document.addEventListener('dragstart', e => {
                if (e.target.classList.contains('lead-card')) {
                    draggedCard = e.target;
                    e.target.classList.add('dragging');
                }
            });

            document.addEventListener('dragend', e => {
                if (e.target.classList.contains('lead-card')) {
                    e.target.classList.remove('dragging');
                }
            });

            document.querySelectorAll('.cards-container').forEach(container => {
                container.addEventListener('dragover', e => e.preventDefault());

                container.addEventListener('drop', async e => {
                    e.preventDefault();
                    if (!draggedCard) return;

                    const buyerId = draggedCard.dataset.id;
                    const newStatus = container.closest('.column').dataset.status;
                    const buyer = buyers.find(b => b.id === buyerId);

                    if (buyer && buyer.status !== newStatus) {
                        buyer.status = newStatus;
                        await updateBuyer(buyerId, { status: newStatus });
                        renderBuyers();
                    }
                });
            });
        }

        // ===== EXPORT CSV =====
        const BUYER_STATUS_LABELS = {
            new: 'Nouveau', active: 'En Recherche Active',
            bought: 'Achet√©', lost: 'Perdu'
        };

        const BANK_LABELS = { oui: 'Oui', non: 'Non', en_cours: 'En cours', ne_sait_pas: 'Ne sait pas' };
        const TIMELINE_LABELS = { immediat: 'Imm√©diat', court_terme: 'Court terme', moyen_terme: 'Moyen terme', long_terme: 'Long terme' };
        const CRITERIA_LABELS = { jardin: 'Jardin', parking: 'Parking', ascenseur: 'Ascenseur', balcon_terrasse: 'Balcon/Terrasse', calme: 'Calme', neuf_renove: 'Neuf/R√©nov√©' };

        function exportToCSV(data, columns, filename) {
            const BOM = '\uFEFF';
            const header = columns.map(c => c.label).join(';');
            const rows = data.map(item =>
                columns.map(c => {
                    let val = c.getValue(item);
                    if (val === null || val === undefined) return '';
                    val = String(val).replace(/"/g, '""');
                    if (val.includes(';') || val.includes('"') || val.includes('\n')) {
                        val = '"' + val + '"';
                    }
                    return val;
                }).join(';')
            );
            const csv = BOM + header + '\n' + rows.join('\n');
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename + '_' + new Date().toISOString().split('T')[0] + '.csv';
            link.click();
            URL.revokeObjectURL(link.href);
        }

        function fmtDate(d) {
            if (!d) return '';
            const dt = new Date(d);
            if (isNaN(dt)) return '';
            return dt.toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit', year: 'numeric' });
        }

        function exportBuyersCSV(statusFilter) {
            let data = buyers;
            let filename = 'acquereurs';
            if (statusFilter) {
                data = buyers.filter(b => b.status === statusFilter);
                filename = 'acquereurs_' + (BUYER_STATUS_LABELS[statusFilter] || statusFilter).toLowerCase().replace(/\s+/g, '-');
            }
            if (data.length === 0) { alert('Aucun acqu√©reur √† exporter.'); return; }

            const columns = [
                { label: 'Statut', getValue: b => BUYER_STATUS_LABELS[b.status] || b.status },
                { label: 'Nom', getValue: b => ((b.first_name || '') + ' ' + (b.last_name || '')).trim() },
                { label: 'T√©l√©phone', getValue: b => b.phone || '' },
                { label: 'Email', getValue: b => b.email || '' },
                { label: 'Type Bien', getValue: b => b.property_type || '' },
                { label: 'Typologie', getValue: b => b.rooms || '' },
                { label: 'Secteur', getValue: b => b.sector || '' },
                { label: 'Surface Min', getValue: b => b.surface_min || '' },
                { label: 'Surface', getValue: b => b.surface || '' },
                { label: 'Annexes', getValue: b => Array.isArray(b.annexes) ? b.annexes.join(', ') : '' },
                { label: 'Budget Min', getValue: b => b.budget_min || '' },
                { label: 'Budget Max', getValue: b => b.budget_max || '' },
                { label: 'Accord Bancaire', getValue: b => BANK_LABELS[b.bank_approval] || b.bank_approval || '' },
                { label: 'D√©lai Projet', getValue: b => TIMELINE_LABELS[b.timeline] || b.timeline || '' },
                { label: 'Vendeur', getValue: b => b.is_seller ? 'Oui' : 'Non' },
                { label: 'Adresse Vendeur', getValue: b => b.seller_address || '' },
                { label: 'Prix Vendeur', getValue: b => b.seller_price || '' },
                { label: 'Crit√®res', getValue: b => {
                    if (!Array.isArray(b.criteria)) return '';
                    return b.criteria.map(c => CRITERIA_LABELS[c] || c).join(', ');
                }},
                { label: '√âl√©ments R√©dhibitoires', getValue: b => b.dealbreakers || '' },
                { label: 'Source', getValue: b => { const c = BUYER_SOURCE_CONFIG[b.source]; return c ? c.label.replace(/^.\s*/, '') : (b.source || ''); }},
                { label: 'Apporteur', getValue: b => b.referrer_name || '' },
                { label: 'Date Relance', getValue: b => fmtDate(b.reminder) },
                { label: 'Notes', getValue: b => '' }
            ];
            exportToCSV(data, columns, filename);
            closeExportDropdown();
        }

        function closeExportDropdown() {
            document.getElementById('exportDropdown').classList.remove('active');
        }

        // ===== APPORTEUR D'AFFAIRE (Recommandation) =====
        function setupReferrerField() {
            const sourceSelect = document.getElementById('source');
            const referrerGroup = document.getElementById('referrerGroup');
            const referrerInput = document.getElementById('referrerName');

            sourceSelect.addEventListener('change', () => {
                if (sourceSelect.value === 'recommandation') {
                    referrerGroup.classList.add('active');
                } else {
                    referrerGroup.classList.remove('active');
                    referrerInput.value = '';
                }
            });

            // Autocomplete contacts pour l'apporteur
            const wrapper = referrerGroup;
            wrapper.style.position = 'relative';
            const dropdown = document.createElement('div');
            dropdown.className = 'ac-dropdown';
            wrapper.appendChild(dropdown);

            let debounceTimer = null;
            let results = [];
            let selIdx = -1;

            referrerInput.addEventListener('input', () => {
                clearTimeout(debounceTimer);
                const q = referrerInput.value.trim();
                if (q.length < 2) { dropdown.classList.remove('active'); return; }
                debounceTimer = setTimeout(() => searchReferrerContacts(q), 300);
            });

            referrerInput.addEventListener('keydown', (e) => {
                if (!dropdown.classList.contains('active')) return;
                if (e.key === 'ArrowDown') { e.preventDefault(); selIdx = Math.min(selIdx + 1, results.length - 1); highlightReferrer(); }
                else if (e.key === 'ArrowUp') { e.preventDefault(); selIdx = Math.max(selIdx - 1, 0); highlightReferrer(); }
                else if (e.key === 'Enter' && selIdx >= 0) { e.preventDefault(); pickReferrer(results[selIdx]); }
                else if (e.key === 'Escape') { dropdown.classList.remove('active'); }
            });

            referrerInput.addEventListener('blur', () => {
                setTimeout(() => dropdown.classList.remove('active'), 200);
            });

            async function searchReferrerContacts(query) {
                const { data: { session } } = await supabaseClient.auth.getSession();
                if (!session) return;
                const { data, error } = await supabaseClient
                    .from('contacts')
                    .select('*')
                    .eq('user_id', session.user.id)
                    .ilike('name', '%' + query + '%')
                    .limit(5);

                if (error || !data || data.length === 0) { dropdown.classList.remove('active'); return; }
                results = data;
                selIdx = -1;
                dropdown.innerHTML = data.map((c, i) => {
                    let details = [];
                    if (c.phone) details.push(`<span>üìû ${escapeHtml(c.phone)}</span>`);
                    if (c.email) details.push(`<span>üìß ${escapeHtml(c.email)}</span>`);
                    return `<div class="ac-item" data-i="${i}">
                        <div class="ac-name">${escapeHtml(c.name)}</div>
                        ${details.length ? `<div class="ac-details">${details.join('')}</div>` : ''}
                    </div>`;
                }).join('');
                dropdown.classList.add('active');
                dropdown.querySelectorAll('.ac-item').forEach(item => {
                    item.addEventListener('click', () => pickReferrer(data[parseInt(item.dataset.i)]));
                });
            }

            function highlightReferrer() {
                dropdown.querySelectorAll('.ac-item').forEach((el, i) => {
                    el.classList.toggle('ac-selected', i === selIdx);
                });
            }

            function pickReferrer(contact) {
                referrerInput.value = contact.name || '';
                dropdown.classList.remove('active');
            }
        }

        // ===== INITIALISATION =====
        document.addEventListener('DOMContentLoaded', () => {
            loadBuyers();
            setupDragAndDrop();
            initMobileTabs();
            setupContactAutocomplete('lastName', 'firstName', 'phone', 'email');
            setupAddressAutocomplete('sector');
            setupReferrerField();

            // Note events
            document.getElementById('noteMicBtn').addEventListener('click', startBuyerNoteRecording);
            document.getElementById('noteAddBtn').addEventListener('click', () => {
                const editId = document.getElementById('submitBtn').dataset.editId;
                if (editId) addBuyerNote(editId);
                else alert('Enregistrez le lead avant d\'ajouter des notes.');
            });
            document.getElementById('noteInput').addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    const editId = document.getElementById('submitBtn').dataset.editId;
                    if (editId) addBuyerNote(editId);
                    else alert('Enregistrez le lead avant d\'ajouter des notes.');
                }
            });

            document.getElementById('dictateBtn').addEventListener('click', handleBuyerDictateClick);
            document.getElementById('addBuyerBtn').addEventListener('click', openModal);

            // Export dropdown toggle
            document.getElementById('exportBtn').addEventListener('click', (e) => {
                e.stopPropagation();
                document.getElementById('exportDropdown').classList.toggle('active');
            });
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.export-wrapper')) closeExportDropdown();
            });
            document.getElementById('closeModalBtn').addEventListener('click', () => closeModal());
            document.getElementById('submitBtn').addEventListener('click', handleSubmit);
            document.getElementById('addLinkBtn').addEventListener('click', addLink);

            // Track form modifications
            document.getElementById('modal').querySelectorAll('input, textarea, select').forEach(el => {
                el.addEventListener('input', () => { formModified = true; });
                el.addEventListener('change', () => { formModified = true; });
            });

            // Entr√©e pour ajouter un lien
            document.getElementById('newLinkUrl').addEventListener('keydown', e => {
                if (e.key === 'Enter') { e.preventDefault(); addLink(); }
            });

            // Toggle vendeur
            document.getElementById('isSeller').addEventListener('change', function() {
                document.getElementById('sellerFields').style.display = this.checked ? 'block' : 'none';
            });

            // Fermer modal
            document.addEventListener('keydown', e => {
                if (e.key === 'Escape' && document.getElementById('modal').classList.contains('active')) closeModal();
            });
            // Backdrop click ‚Äî ferme si pas de modifications
            document.getElementById('modal').addEventListener('click', e => {
                if (e.target === document.getElementById('modal')) closeModal();
            });

            // Clic alertes
            // Grab & drag horizontal du pipeline
            const pipelineEl = document.querySelector('.pipeline');
            if (pipelineEl) {
                let isGrabbing = false;
                let grabStartX = 0;
                let grabScrollLeft = 0;

                pipelineEl.addEventListener('mousedown', (e) => {
                    if (e.target.closest('.lead-card, button, a, input, select, textarea, .modal')) return;
                    isGrabbing = true;
                    pipelineEl.classList.add('grabbing');
                    grabStartX = e.pageX - pipelineEl.offsetLeft;
                    grabScrollLeft = pipelineEl.scrollLeft;
                    e.preventDefault();
                });

                pipelineEl.addEventListener('mousemove', (e) => {
                    if (!isGrabbing) return;
                    e.preventDefault();
                    const x = e.pageX - pipelineEl.offsetLeft;
                    pipelineEl.scrollLeft = grabScrollLeft - (x - grabStartX) * 1.5;
                });

                pipelineEl.addEventListener('mouseup', () => {
                    isGrabbing = false;
                    pipelineEl.classList.remove('grabbing');
                });

                pipelineEl.addEventListener('mouseleave', () => {
                    isGrabbing = false;
                    pipelineEl.classList.remove('grabbing');
                });
            }

            document.getElementById('alertCounter').addEventListener('click', () => {
                const cards = document.querySelectorAll('.lead-card');
                for (let card of cards) {
                    if (card.querySelector('.badge-alert')) {
                        card.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        card.style.animation = 'none';
                        setTimeout(() => { card.style.animation = 'highlight 1s ease'; }, 10);
                        break;
                    }
                }
            });
        });
    </script>
    <div class="move-popup-overlay" id="movePopup">
        <div class="move-popup">
            <div class="move-popup-title">üìÇ D√©placer vers...</div>
            <div class="move-popup-options" id="movePopupOptions"></div>
            <button class="move-popup-cancel" id="movePopupCancel">Annuler</button>
        </div>
    </div>
    <script src="js/todo-widget.js"></script>
</body>
</html>
